<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Small Multiples - Habita√ß√µes Portugal</title>
  
  <!-- Carregar modo escuro IMEDIATAMENTE (antes de qualquer CSS) -->
  <script>
    if (localStorage.getItem('darkMode') === 'true') {
      document.write('<style>body{background:#1a1a1a!important;color:#e0e0e0!important;}</style>');
    }
  </script>
  
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: white;
      --text: #2c3e50;
      --border: #e1e8ed;
      --primary: #005b96;
      --header-bg: linear-gradient(135deg, #005b96, #5a2a82);
    }

    body.dark {
      --bg: #1a1a1a;
      --card-bg: #2d2d2d;
      --text: #e0e0e0;
      --border: #444;
      --primary: #64b5f6;
      --header-bg: linear-gradient(135deg, #000000, #3a1757);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
    }

    header {
      background: var(--header-bg);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .back-btn {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 5px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .dark-toggle {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 5px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--border);
    }

    .tab {
      padding: 15px 30px;
      background: transparent;
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .source-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    body.dark .source-box {
      background: rgba(255, 193, 7, 0.1);
    }

    /* Small Multiples Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 25px;
      margin-bottom: 30px;
    }

    .grid-item {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .grid-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .grid-title {
      text-align: center;
      font-weight: bold;
      color: var(--primary);
      font-size: 18px;
      margin-bottom: 10px;
    }

    .treemap-small {
      width: 100%;
      height: 400px;
    }

    /* Padr√µes Temporais */
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .btn {
      padding: 10px 20px;
      margin: 0 5px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .distrito-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .distrito-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .distrito-card h4 {
      color: var(--primary);
      margin-bottom: 10px;
    }

    .sparkline {
      width: 100%;
      height: 60px;
      margin: 10px 0;
    }

    .distrito-stats {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .analysis-box {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .analysis-box h3 {
      color: var(--primary);
      margin-bottom: 15px;
    }

    .analysis-box ul {
      margin-left: 20px;
      line-height: 1.8;
    }

    .analysis-box li {
      margin-bottom: 10px;
    }

    .legend {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .legend-box {
      width: 30px;
      height: 20px;
      border: 1px solid var(--border);
    }

    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 10px;
      border-radius: 5px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
      font-size: 13px;
    }

    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .distrito-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">‚Üê Voltar ao in√≠cio</a>
  <h1>‚è±Ô∏è Small Multiples</h1>
  <p>An√°lise Temporal ‚Äî Habita√ß√µes por Distrito (1940‚Äì2021)</p>
  <button class="dark-toggle" onclick="toggleDark()" id="darkModeBtn" title="Alternar modo">
    <span id="darkModeIcon">üåô</span>
  </button>
</header>

<div class="container">
  <div class="tabs">
    <button class="tab active" onclick="switchTab(0)">üìä Grelha Comparativa</button>
    <button class="tab" onclick="switchTab(1)">üìà Padr√µes Temporais</button>
  </div>

  <!-- TAB 1: GRELHA COMPARATIVA -->
  <div class="tab-content active" id="tab1">
    <div class="source-box">
      <strong>üéØ Objetivo:</strong> Visualizar todos os anos simultaneamente para identificar padr√µes de evolu√ß√£o
    </div>

    <h2 style="text-align: center; margin-bottom: 20px;">Evolu√ß√£o 1940-2021</h2>

    <!-- SELECTOR DE ANO BASE -->
    <div style="text-align: center; margin-bottom: 20px;">
      <label style="font-weight: bold; margin-right: 10px;">üìÖ Comparar todos os anos com:</label>
      <select id="anoBase" onchange="atualizarComparacao()" style="padding: 8px 15px; border-radius: 5px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-size: 14px; cursor: pointer;">
        <option value="1940" selected>1940 (ano inicial)</option>
        <option value="1950">1950</option>
        <option value="1960">1960</option>
        <option value="1981">1981</option>
        <option value="1991">1991</option>
        <option value="2001">2001</option>
        <option value="2011">2011</option>
        <option value="2021">2021 (ano final)</option>
      </select>
    </div>

    <!-- COMPARA√á√ÉO NUM√âRICA -->
    <div id="comparacao" style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
      <!-- Preenchido dinamicamente -->
    </div>

    <div class="legend">
      <span style="font-weight: bold;">Legenda:</span>
      <div class="legend-item">
        <div class="legend-box" style="background: #deebf7"></div>
        <span>&lt; 90k</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: #c6dbef"></div>
        <span>90k-120k</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: #6baed6"></div>
        <span>180k-250k</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: #2171b5"></div>
        <span>350k-500k</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: #084594"></div>
        <span>500k+</span>
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <div class="analysis-box">
      <h3>üìä O que observar nesta grelha:</h3>
      <div id="analiseGrelha">
        <ul>
          <li><strong>Crescimento de Lisboa:</strong> Observe como o ret√¢ngulo de Lisboa aumenta dramaticamente de 1940 para 2021.</li>
          <li><strong>Estabilidade do Porto:</strong> Porto mant√©m-se grande em todos os anos, mas cresce mais lentamente que Lisboa.</li>
          <li><strong>Emerg√™ncia de Set√∫bal:</strong> Set√∫bal torna-se cada vez mais proeminente ap√≥s 1960.</li>
          <li><strong>Distritos interiores:</strong> Bragan√ßa, Guarda, Portalegre mant√™m-se pequenos ao longo de todo o per√≠odo.</li>
          <li><strong>Mesma escala:</strong> Todos os treemaps usam a mesma escala de cores, permitindo compara√ß√£o direta entre anos.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- TAB 2: PADR√ïES TEMPORAIS -->
  <div class="tab-content" id="tab2">
    <div class="source-box">
      <strong>üéØ Objetivo:</strong> Analisar padr√µes de crescimento individuais por distrito ao longo de 8 d√©cadas
    </div>

    <h2 style="text-align: center; margin-bottom: 20px;">Padr√µes de Crescimento por Distrito</h2>

    <div class="controls">
      <button class="btn" onclick="ordenarPor('crescimento')">Ordenar por Crescimento (%)</button>
      <button class="btn" onclick="ordenarPor('absoluto')">Ordenar por Valor Absoluto</button>
      <button class="btn" onclick="ordenarPor('alfabetico')">Ordenar Alfabeticamente</button>
    </div>

    <div id="distrito-grid" class="distrito-grid"></div>

    <div class="analysis-box">
      <h3>üîç Insights Principais:</h3>
      <div id="insights"></div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
const anos = [1940, 1950, 1960, 1981, 1991, 2001, 2011, 2021];
let dadosOriginais = null;
let ordenacao = 'crescimento';

const distritoNUTS = {
  'Aveiro': 'Centro', 'Beja': 'Alentejo', 'Braga': 'Norte',
  'Bragan√ßa': 'Norte', 'Castelo Branco': 'Centro', 'Coimbra': 'Centro',
  '√âvora': 'Alentejo', 'Faro': 'Algarve', 'Guarda': 'Centro',
  'Leiria': 'Centro', 'Lisboa': 'Lisboa', 'Portalegre': 'Alentejo',
  'Porto': 'Norte', 'Santar√©m': 'Lisboa', 'Set√∫bal': 'Lisboa',
  'Viana do Castelo': 'Norte', 'Vila Real': 'Norte', 'Viseu': 'Centro',
  'R. A. A√ßores': 'A√ßores', 'R. A. Madeira': 'Madeira'
};

function getColorByValue(value) {
  const blues = ['#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#084594'];
  return value > 500000 ? blues[6] :
         value > 350000 ? blues[5] :
         value > 250000 ? blues[4] :
         value > 180000 ? blues[3] :
         value > 120000 ? blues[2] :
         value > 90000  ? blues[1] : blues[0];
}

// Aplicar modo escuro ao carregar
const isDarkMode = localStorage.getItem('darkMode') === 'true';
if (isDarkMode) {
  document.body.classList.add('dark');
}

// Atualizar √≠cone do bot√£o
function updateDarkModeButton() {
  const icon = document.getElementById('darkModeIcon');
  const btn = document.getElementById('darkModeBtn');
  if (icon && btn) {
    if (isDarkMode) {
      icon.textContent = '‚òÄÔ∏è';
      btn.setAttribute('title', 'Mudar para modo claro');
    } else {
      icon.textContent = 'üåô';
      btn.setAttribute('title', 'Mudar para modo escuro');
    }
  }
}

// Atualizar ao carregar
updateDarkModeButton();

function toggleDark() {
  document.body.classList.toggle('dark');
  // Guardar prefer√™ncia
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('darkMode', isDark ? 'true' : 'false');
  
  // Recarregar p√°gina para aplicar mudan√ßa
  window.location.reload();
}

function switchTab(index) {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach((tab, i) => {
    if (i === index) {
      tab.classList.add('active');
      contents[i].classList.add('active');
    } else {
      tab.classList.remove('active');
      contents[i].classList.remove('active');
    }
  });

  if (index === 0) {
    setTimeout(() => {
      desenharGrelha();
      atualizarComparacao();
    }, 100);
  } else if (index === 1) {
    setTimeout(() => desenharPadroes(), 100);
  }
}

function atualizarComparacao() {
  if (!dadosOriginais) return;
  
  const anoBase = parseInt(document.getElementById('anoBase').value);
  const comparacaoDiv = document.getElementById('comparacao');
  const analiseDiv = document.getElementById('analiseGrelha');
  const dadosBase = dadosOriginais[anoBase];
  
  if (!dadosBase) return;
  
  // Calcular totais e varia√ß√µes
  const totalBase = Object.values(dadosBase).reduce((sum, v) => sum + v, 0);
  
  // Calcular varia√ß√µes para cada ano
  const variacoes = anos.map(ano => {
    const dados = dadosOriginais[ano];
    if (!dados || ano === anoBase) return null;
    
    const total = Object.values(dados).reduce((sum, v) => sum + v, 0);
    const diff = total - totalBase;
    const perc = ((total / totalBase - 1) * 100).toFixed(1);
    
    return { ano, total, diff, perc };
  }).filter(v => v !== null);
  
  // Encontrar maior e menor crescimento
  const sorted = [...variacoes].sort((a, b) => b.diff - a.diff);
  const maiorCrescimento = sorted[0];
  const menorCrescimento = sorted[sorted.length - 1];
  
  // Mostrar compara√ß√£o
  comparacaoDiv.style.display = 'block';
  comparacaoDiv.innerHTML = `
    <h3 style="margin-top: 0; color: var(--primary); text-align: center;">
      üìä Compara√ß√£o com ${anoBase} (base: ${totalBase.toLocaleString('pt-PT')} habita√ß√µes)
    </h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
      ${variacoes.map(v => `
        <div style="padding: 12px; background: ${v.diff > 0 ? 'rgba(46, 125, 50, 0.1)' : 'rgba(211, 47, 47, 0.1)'}; border-radius: 6px; border-left: 3px solid ${v.diff > 0 ? '#2e7d32' : '#d32f2f'};">
          <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${v.ano}</div>
          <div style="font-size: 14px;">${v.total.toLocaleString('pt-PT')} hab</div>
          <div style="font-size: 13px; color: ${v.diff > 0 ? '#2e7d32' : '#d32f2f'}; font-weight: bold;">
            ${v.diff > 0 ? '+' : ''}${v.diff.toLocaleString('pt-PT')} (${v.perc > 0 ? '+' : ''}${v.perc}%)
          </div>
        </div>
      `).join('')}
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 6px;">
      <strong style="color: var(--primary);">üí° Destaques:</strong><br>
      ${maiorCrescimento.diff > 0 ? 
        `<span style="color: #2e7d32;">üîù Maior crescimento vs ${anoBase}: ${maiorCrescimento.ano} (+${maiorCrescimento.perc}%)</span><br>` : 
        `<span style="color: #d32f2f;">üìâ Ano mais distante de ${anoBase}: ${maiorCrescimento.ano} (tinha ${maiorCrescimento.perc}% menos)</span><br>`}
      ${menorCrescimento.diff < 0 ? 
        `<span style="color: #d32f2f;">üìä Ano mais pr√≥ximo de ${anoBase}: ${menorCrescimento.ano} (tinha ${menorCrescimento.perc}% menos)</span>` : 
        `<span style="color: #2e7d32;">üìä Menor crescimento vs ${anoBase}: ${menorCrescimento.ano} (+${menorCrescimento.perc}%)</span>`}
    </div>
  `;
  
  // ATUALIZAR AN√ÅLISE DA GRELHA DINAMICAMENTE
  atualizarAnaliseGrelha(anoBase);
}

function atualizarAnaliseGrelha(anoBase) {
  const analiseDiv = document.getElementById('analiseGrelha');
  if (!dadosOriginais || !analiseDiv) return;
  
  // Calcular estat√≠sticas para Lisboa, Porto, Set√∫bal
  const lisboaBase = dadosOriginais[anoBase]['Lisboa'] || 0;
  const portoBase = dadosOriginais[anoBase]['Porto'] || 0;
  const setubalBase = dadosOriginais[anoBase]['Set√∫bal'] || 0;
  
  const lisboa2021 = dadosOriginais[2021]['Lisboa'] || 0;
  const porto2021 = dadosOriginais[2021]['Porto'] || 0;
  const setubal2021 = dadosOriginais[2021]['Set√∫bal'] || 0;
  
  const lisboa1940 = dadosOriginais[1940]['Lisboa'] || 0;
  const porto1940 = dadosOriginais[1940]['Porto'] || 0;
  const setubal1940 = dadosOriginais[1940]['Set√∫bal'] || 0;
  
  // Calcular crescimentos
  const lisboaCrescimento = ((lisboa2021 / lisboaBase - 1) * 100).toFixed(1);
  const portoCrescimento = ((porto2021 / portoBase - 1) * 100).toFixed(1);
  const setubalCrescimento = ((setubal2021 / setubalBase - 1) * 100).toFixed(1);
  
  // Comparar Lisboa vs Porto
  const lisboaMaior = lisboaBase > portoBase;
  const maiorDistrito = lisboaMaior ? 'Lisboa' : 'Porto';
  const menorDistrito = lisboaMaior ? 'Porto' : 'Lisboa';
  
  // Anos antes e depois do base
  const anosAntes = anos.filter(a => a < anoBase);
  const anosDepois = anos.filter(a => a > anoBase);
  
  let analiseHTML = '<ul>';
  
  // An√°lise din√¢mica baseada no ano
  if (anoBase === 1940) {
    analiseHTML += `
      <li><strong>Crescimento de Lisboa:</strong> Observa-se como o ret√¢ngulo de Lisboa aumenta dramaticamente de ${anoBase} (+${lisboaCrescimento}%) at√© 2021.</li>
      <li><strong>Estabilidade do Porto:</strong> Compara-se o Porto em todos os anos (+${portoCrescimento}%) ‚Äî cresce de forma mais gradual que Lisboa.</li>
      <li><strong>Emerg√™ncia de Set√∫bal:</strong> Nota-se como Set√∫bal se torna cada vez mais proeminente ap√≥s 1960 (+${setubalCrescimento}% desde ${anoBase}).</li>
    `;
  } else if (anoBase === 2021) {
    analiseHTML += `
      <li><strong>Perspetiva hist√≥rica:</strong> Em ${anoBase}, Lisboa tinha ${lisboa2021.toLocaleString('pt-PT')} habita√ß√µes. Observa-se como era menor nos anos anteriores.</li>
      <li><strong>Evolu√ß√£o do Porto:</strong> Porto tinha ${porto2021.toLocaleString('pt-PT')} habita√ß√µes em ${anoBase}. Compara-se com os anos anteriores para ver o crescimento hist√≥rico.</li>
      <li><strong>Contexto de Set√∫bal:</strong> Set√∫bal alcan√ßou ${setubal2021.toLocaleString('pt-PT')} habita√ß√µes em ${anoBase}. Observa-se como cresceu desde 1940.</li>
    `;
  } else {
    // Anos interm√©dios
    analiseHTML += `
      <li><strong>Lisboa em ${anoBase}:</strong> Com ${lisboaBase.toLocaleString('pt-PT')} habita√ß√µes como base, ${anosDepois.length > 0 ? 'observa-se o crescimento de ' + lisboaCrescimento + '% at√© 2021' : 'compara-se com o valor de 1940'}.</li>
      <li><strong>Porto em ${anoBase}:</strong> Com ${portoBase.toLocaleString('pt-PT')} habita√ß√µes, ${Math.abs(portoCrescimento)}% ${portoCrescimento > 0 ? 'de crescimento at√© 2021' : 'menor que em 2021'}.</li>
      <li><strong>Set√∫bal em ${anoBase}:</strong> Com ${setubalBase.toLocaleString('pt-PT')} habita√ß√µes, ${Math.abs(setubalCrescimento)}% ${setubalCrescimento > 0 ? 'de crescimento at√© 2021' : 'menor que em 2021'}.</li>
    `;
  }
  
  analiseHTML += `
    <li><strong>Distritos interiores:</strong> Nota-se que Bragan√ßa, Guarda e Portalegre se mant√™m pequenos ${anosAntes.length > 0 ? 'antes de ' + anoBase : 'desde ' + anoBase} e ${anosDepois.length > 0 ? 'ap√≥s ' + anoBase : 'at√© 2021'}.</li>
    <li><strong>Mesma escala:</strong> Compara-se visualmente ‚Äî todos os treemaps usam a mesma escala de cores em rela√ß√£o a ${anoBase}.</li>
  `;
  
  analiseHTML += '</ul>';
  
  analiseDiv.innerHTML = analiseHTML;
}

function desenharGrelha() {
  const container = document.getElementById('grid');
  if (!container || !dadosOriginais) return;
  
  container.innerHTML = '';
  
  anos.forEach(ano => {
    const dados = dadosOriginais[ano];
    if (!dados) return;
    
    const div = document.createElement('div');
    div.className = 'grid-item';
    div.innerHTML = `
      <div class="grid-title">${ano}</div>
      <div id="treemap-${ano}" class="treemap-small"></div>
    `;
    container.appendChild(div);
    
    setTimeout(() => desenharTreemapPequeno(ano, dados), 50);
  });
}

function desenharTreemapPequeno(ano, dados) {
  const container = document.getElementById(`treemap-${ano}`);
  if (!container) return;
  
  const width = container.clientWidth;
  const height = 400;
  
  const dadosArray = Object.entries(dados).map(([distrito, habitacoes]) => ({
    name: distrito,
    value: habitacoes
  }));
  
  const root = d3.hierarchy({ children: dadosArray })
    .sum(d => d.value)
    .sort((a, b) => b.value - a.value);
  
  d3.treemap()
    .size([width, height])
    .padding(1.5)
    (root);
  
  const svg = d3.select(`#treemap-${ano}`)
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  const nodes = svg.selectAll('g')
    .data(root.leaves())
    .enter()
    .append('g')
    .attr('transform', d => `translate(${d.x0},${d.y0})`);
  
  nodes.append('rect')
    .attr('width', d => d.x1 - d.x0)
    .attr('height', d => d.y1 - d.y0)
    .attr('fill', d => getColorByValue(d.data.value))
    .attr('stroke', '#fff')
    .attr('stroke-width', 1.5)
    .on('mouseover', function(event, d) {
      d3.select(this).style('opacity', 0.9);
      const tooltip = d3.select('#tooltip');
      tooltip.style('opacity', 1)
        .html(`<strong>${d.data.name}</strong><br>Ano: ${ano}<br>Habita√ß√µes: ${d.data.value.toLocaleString('pt-PT')}`)
        .style('left', (event.pageX + 10) + 'px')
        .style('top', (event.pageY - 10) + 'px');
    })
    .on('mouseout', function() {
      d3.select(this).style('opacity', 1);
      d3.select('#tooltip').style('opacity', 0);
    });
  
  nodes.append('text')
    .attr('x', d => (d.x1 - d.x0) / 2)
    .attr('y', d => (d.y1 - d.y0) / 2)
    .attr('text-anchor', 'middle')
    .attr('alignment-baseline', 'middle')
    .style('fill', '#000')
    .style('font-size', '13px')
    .style('font-weight', 'bold')
    .style('pointer-events', 'none')
    .text(d => {
      const w = d.x1 - d.x0;
      const h = d.y1 - d.y0;
      // Threshold muito reduzido: 20x15 (quase todos aparecem)
      if (w < 20 || h < 15) return '';
      const nome = d.data.name;
      // Abrevia√ß√£o progressiva
      if (w < 50 && nome.length > 6) return nome.substring(0, 5) + '.';
      if (w < 70 && nome.length > 8) return nome.substring(0, 7) + '.';
      return nome;
    });
}

function ordenarPor(tipo) {
  ordenacao = tipo;
  desenharPadroes();
}

function desenharPadroes() {
  const container = document.getElementById('distrito-grid');
  const insightsContainer = document.getElementById('insights');
  
  if (!container || !dadosOriginais) return;
  
  const estatisticas = [];
  const distritos = Object.keys(dadosOriginais[2021]);
  
  distritos.forEach(distrito => {
    const valores = anos.map(ano => dadosOriginais[ano]?.[distrito] || 0);
    const valor1940 = valores[0];
    const valor2021 = valores[valores.length - 1];
    const crescimentoPerc = valor1940 > 0 ? ((valor2021 / valor1940 - 1) * 100) : 0;
    
    estatisticas.push({
      distrito,
      valores,
      valor1940,
      valor2021,
      crescimentoPerc
    });
  });
  
  if (ordenacao === 'crescimento') {
    estatisticas.sort((a, b) => b.crescimentoPerc - a.crescimentoPerc);
  } else if (ordenacao === 'absoluto') {
    estatisticas.sort((a, b) => b.valor2021 - a.valor2021);
  } else {
    estatisticas.sort((a, b) => a.distrito.localeCompare(b.distrito));
  }
  
  container.innerHTML = '';
  
  estatisticas.forEach(stat => {
    const card = document.createElement('div');
    card.className = 'distrito-card';
    card.innerHTML = `
      <h4>${stat.distrito}</h4>
      <div id="spark-${stat.distrito.replace(/\s+/g, '-')}" class="sparkline"></div>
      <div class="distrito-stats">
        <span><strong>1940:</strong> ${stat.valor1940.toLocaleString('pt-PT')}</span>
        <span><strong>2021:</strong> ${stat.valor2021.toLocaleString('pt-PT')}</span>
        <span style="color: ${stat.crescimentoPerc > 0 ? '#2e7d32' : '#d32f2f'}">
          <strong>${stat.crescimentoPerc > 0 ? '+' : ''}${stat.crescimentoPerc.toFixed(1)}%</strong>
        </span>
      </div>
    `;
    container.appendChild(card);
    
    setTimeout(() => desenharSparkline(stat.distrito, stat.valores), 50);
  });
  
  // Insights
  const top3Crescimento = [...estatisticas].sort((a, b) => b.crescimentoPerc - a.crescimentoPerc).slice(0, 3);
  const top3Absoluto = [...estatisticas].sort((a, b) => b.valor2021 - a.valor2021).slice(0, 3);
  
  insightsContainer.innerHTML = `
    <h4 style="color: #2e7d32;">üìà Maior Crescimento Relativo (1940-2021):</h4>
    <ul>
      ${top3Crescimento.map(s => `<li><strong>${s.distrito}:</strong> +${s.crescimentoPerc.toFixed(1)}% (${s.valor1940.toLocaleString('pt-PT')} ‚Üí ${s.valor2021.toLocaleString('pt-PT')})</li>`).join('')}
    </ul>
    
    <h4 style="color: #1565c0; margin-top: 15px;">üèÜ Maiores em Valor Absoluto (2021):</h4>
    <ul>
      ${top3Absoluto.map(s => `<li><strong>${s.distrito}:</strong> ${s.valor2021.toLocaleString('pt-PT')} habita√ß√µes</li>`).join('')}
    </ul>
  `;
}

function desenharSparkline(distrito, valores) {
  const id = distrito.replace(/\s+/g, '-');
  const container = document.getElementById(`spark-${id}`);
  if (!container) return;
  
  const width = container.clientWidth;
  const height = 60;
  
  const svg = d3.select(`#spark-${id}`)
    .append('svg')
    .attr('width', width)
    .attr('height', height);
  
  const x = d3.scaleLinear()
    .domain([0, valores.length - 1])
    .range([5, width - 5]);
  
  const y = d3.scaleLinear()
    .domain([0, d3.max(valores)])
    .range([height - 5, 5]);
  
  const line = d3.line()
    .x((d, i) => x(i))
    .y(d => y(d))
    .curve(d3.curveMonotoneX);
  
  const area = d3.area()
    .x((d, i) => x(i))
    .y0(height - 5)
    .y1(d => y(d))
    .curve(d3.curveMonotoneX);
  
  svg.append('path')
    .datum(valores)
    .attr('fill', '#2196f3')
    .attr('fill-opacity', 0.2)
    .attr('d', area);
  
  svg.append('path')
    .datum(valores)
    .attr('fill', 'none')
    .attr('stroke', '#2196f3')
    .attr('stroke-width', 2)
    .attr('d', line);
  
  svg.selectAll('circle')
    .data(valores)
    .enter()
    .append('circle')
    .attr('cx', (d, i) => x(i))
    .attr('cy', d => y(d))
    .attr('r', 2)
    .attr('fill', '#1976d2');
}

async function init() {
  try {
    const response = await fetch('habitacoes_por_ano.json');
    dadosOriginais = await response.json();
    desenharGrelha();
    atualizarComparacao();
  } catch (error) {
    console.error('Erro ao carregar dados:', error);
  }
}

init();
</script>

<footer style="text-align: center; padding: 20px; font-size: 12px; opacity: 0.7;">
   P√°gina desenvolvida no √¢mbito da unidade curricular ‚ÄúVisualiza√ß√£o de Informa√ß√£o‚Äù
    (MEIW ‚Äì Universidade Aberta).
</footer>

</body>
</html>
