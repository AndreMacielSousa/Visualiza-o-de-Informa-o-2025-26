<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treemap ‚Äî Habita√ß√µes por Distrito (1940‚Äì2021)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <style>
    :root {
      --bg: #f5f5f5;
      --text: #222222;
      --card-bg: #ffffff;
      --header-bg: linear-gradient(135deg, #005b96, #5a2a82);
      --header-text: #ffffff;
      --accent: #005b96;
      --tab-active: #005b96;
      --tab-inactive: #cccccc;
    }

    body.dark {
      --bg: #121212;
      --text: #e3e3e3;
      --card-bg: #1f1f1f;
      --header-bg: linear-gradient(135deg, #000000, #3a1757);
      --accent: #7ab5ff;
      --tab-active: #7ab5ff;
      --tab-inactive: #444444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 20px 15px;
      text-align: center;
      position: relative;
    }

    header h1 {
      font-size: 24px;
      margin: 5px 0;
    }

    header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .back-btn {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 15px;
      text-decoration: none;
      border-radius: 5px;
      font-size: 14px;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .dark-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 18px;
      transition: background 0.3s;
    }

    .dark-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* SISTEMA DE TABS */
    .tabs-container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 15px;
    }

    .main-tabs {
      display: flex;
      gap: 10px;
      border-bottom: 3px solid var(--tab-inactive);
      margin-bottom: 20px;
    }

    .main-tab {
      padding: 12px 24px;
      background: var(--tab-inactive);
      color: var(--text);
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
    }

    .main-tab.active {
      background: var(--tab-active);
      color: white;
      transform: translateY(3px);
    }

    .main-tab:hover:not(.active) {
      opacity: 0.8;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* SUB-TABS (para Tab 1) */
    .sub-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .sub-tab {
      padding: 10px 20px;
      background: var(--card-bg);
      border: 2px solid var(--tab-inactive);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
      transition: all 0.3s;
    }

    .sub-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .sub-tab:hover:not(.active) {
      border-color: var(--accent);
    }

    .sub-content {
      display: none;
    }

    .sub-content.active {
      display: block;
    }

    /* LAYOUT LADO A LADO */
    .split-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .split-panel {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .split-panel h3 {
      color: var(--accent);
      margin-bottom: 15px;
      font-size: 18px;
    }

    .map-iframe {
      width: 100%;
      height: 700px;
      border: none;
      border-radius: 5px;
    }

    /* CAIXA DE AN√ÅLISE */
    .analysis-box {
      background: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
      line-height: 1.6;
    }

    body.dark .analysis-box {
      background: #3d3418;
      border-left-color: #ffeb3b;
    }

    .analysis-box h3 {
      color: #856404;
      margin-bottom: 15px;
      font-size: 20px;
    }

    body.dark .analysis-box h3 {
      color: #ffc107;
    }
    
    .analysis-box h4 {
      font-size: 16px;
      margin-top: 15px;
      margin-bottom: 10px;
    }
    
    .analysis-box ul {
      margin-left: 20px;
    }
    
    .analysis-box li {
      margin-bottom: 8px;
    }

    .analysis-box ul {
      margin-left: 20px;
      line-height: 1.8;
    }

    .analysis-box li {
      margin-bottom: 10px;
    }

    .analysis-box strong {
      color: #856404;
    }

    body.dark .analysis-box strong {
      color: #ffeb3b;
    }

    /* Resto dos estilos do treemap original */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .source-box {
      background: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
      font-size: 14px;
      line-height: 1.6;
    }

    body.dark .source-box {
      background: #3d3418;
      border-left-color: #ffeb3b;
    }

    .controls {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .control-section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    body.dark .control-section {
      border-bottom-color: #333;
    }

    .control-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .control-section h3 {
      color: var(--accent);
      font-size: 16px;
      margin-bottom: 12px;
    }

    .year-display {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      text-align: center;
      margin: 15px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
    }

    .slider-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
    }

    input[type="range"] {
      flex: 1;
      min-width: 200px;
      height: 8px;
      border-radius: 4px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: transform 0.2s;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: none;
    }

    select, button {
      padding: 10px 20px;
      font-size: 14px;
      border: 2px solid var(--accent);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    select {
      background: var(--card-bg);
      color: var(--text);
    }

    button {
      font-weight: 600;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border-color: #6c757d;
    }

    .btn-secondary:hover {
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .speed-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 15px 0;
    }

    .speed-btn {
      padding: 8px 16px;
      background: var(--card-bg);
      border: 2px solid #ccc;
      color: var(--text);
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
    }

    .speed-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .speed-btn:hover:not(.active) {
      border-color: var(--accent);
    }

    #treemap {
      width: 100%;
      height: 600px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 300px;
    }

    .tooltip-title {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.3);
    }

    .tooltip-content {
      line-height: 1.6;
    }

    /* LEGENDA DE CORES */
    .color-legend {
      display: flex;
      align-items: center;
      gap: 20px;
      margin: 15px 0;
      padding: 12px;
      background: var(--card-bg);
      border-radius: 5px;
      font-size: 13px;
      flex-wrap: wrap;
    }

    .legend-title {
      font-weight: 700;
      color: var(--text);
    }

    .legend-scale {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .legend-box {
      width: 30px;
      height: 20px;
      border: 1px solid #ddd;
    }

    .legend-label {
      font-size: 11px;
      color: var(--text);
      margin: 0 5px;
    }

    @media (max-width: 768px) {
      .split-view {
        grid-template-columns: 1fr;
      }
      
      .main-tabs {
        flex-direction: column;
      }
      
      .nav-buttons {
        flex-direction: column;
      }
      
      .speed-controls {
        flex-wrap: wrap;
      }
      
      #treemap {
        height: 400px;
      }
      
      .map-iframe {
        height: 500px;
      }
    }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">‚Üê Voltar ao in√≠cio</a>
  <h1>üß© Treemap</h1>
  <p>Habita√ß√µes por Distrito ‚Äî Portugal (1940‚Äì2021)</p>
  <button class="dark-toggle" onclick="toggleDark()" id="darkModeBtn" title="Alternar modo">
    <span id="darkModeIcon">üåô</span>
  </button>
</header>

<div class="tabs-container">
  <!-- MAIN TABS -->
  <div class="main-tabs">
    <button class="main-tab active" onclick="switchMainTab(0)">üìä Representa√ß√£o Proporcional</button>
    <button class="main-tab" onclick="switchMainTab(1)">üó∫Ô∏è Avalia√ß√£o da Perda de Georrefer√™ncia</button>
  </div>

  <!-- TAB 1: REPRESENTA√á√ÉO PROPORCIONAL -->
  <div class="tab-content active" id="tab1">
    <div class="source-box">
      <strong>üéØ Objetivo:</strong> Comparar magnitudes atrav√©s de √°reas proporcionais ao n√∫mero de habita√ß√µes
    </div>

    <!-- SUB-TABS -->
    <div class="sub-tabs">
      <button class="sub-tab active" onclick="switchSubTab(0)">Treemap</button>
      <button class="sub-tab" onclick="switchSubTab(1)">Treemap + Mapa</button>
      <button class="sub-tab" onclick="switchSubTab(2)">Gr√°fico de Barras</button>
    </div>

    <!-- SUB-TAB 1A: TREEMAP SOLO -->
    <div class="sub-content active" id="subtab1a">
      <div class="container">
        <div class="controls">
          <div class="control-section">
            <h3>üìÖ SELECIONAR ANO</h3>
            <div class="year-display" id="yearDisplay1a">1940</div>
            <div class="nav-buttons">
              <button id="prevBtn1a" class="btn-primary">‚óÑ Anterior</button>
              <select id="yearSelect1a"></select>
              <button id="nextBtn1a" class="btn-primary">Seguinte ‚ñ∫</button>
            </div>
          </div>

          <div class="control-section">
            <h3>‚è±Ô∏è LINHA DO TEMPO</h3>
            <div class="slider-container">
              <span class="slider-label">1940</span>
              <input type="range" id="yearSlider1a" min="0" max="7" value="0" step="1">
              <span class="slider-label">2021</span>
            </div>
          </div>

          <div class="control-section">
            <h3>üé¨ REPRODU√á√ÉO AUTOM√ÅTICA</h3>
            <div class="nav-buttons">
              <button id="playBtn1a" class="btn-primary">‚ñ∂ Reproduzir Evolu√ß√£o</button>
              <button id="resetBtn1a" class="btn-primary">‚ü≤ Reiniciar (1940)</button>
            </div>
            <div class="speed-controls">
              <button class="speed-btn" data-speed="3000">0.5√ó</button>
              <button class="speed-btn active" data-speed="1500">1√ó</button>
              <button class="speed-btn" data-speed="750">2√ó</button>
              <button class="speed-btn" data-speed="375">4√ó</button>
            </div>
          </div>
        </div>

        <div id="treemap1a"></div>
        
        <!-- LEGENDA -->
        <div class="color-legend">
          <span class="legend-title">üìä Legenda:</span>
          <div class="legend-scale">
            <div class="legend-box" style="background: #f7fbff"></div>
            <span class="legend-label">&lt; 70k</span>
            <div class="legend-box" style="background: #c6dbef"></div>
            <span class="legend-label">90k-120k</span>
            <div class="legend-box" style="background: #6baed6"></div>
            <span class="legend-label">180k-250k</span>
            <div class="legend-box" style="background: #2171b5"></div>
            <span class="legend-label">350k+</span>
          </div>
          <span class="legend-label">Habita√ß√µes por distrito</span>
        </div>
      </div>
    </div>

    <!-- SUB-TAB 1B: TREEMAP + MAPA -->
    <div class="sub-content" id="subtab1b">
      <div class="split-view">
        <!-- PAINEL ESQUERDO: TREEMAP -->
        <div class="split-panel">
          <h3>üß© Treemap (Representa√ß√£o Proporcional)</h3>
          <div class="controls">
            <div class="year-display" id="yearDisplay1b">1940</div>
            <div class="nav-buttons">
              <button id="prevBtn1b" class="btn-primary">‚óÑ</button>
              <select id="yearSelect1b"></select>
              <button id="nextBtn1b" class="btn-primary">‚ñ∫</button>
            </div>
            <div class="slider-container">
              <span class="slider-label">1940</span>
              <input type="range" id="yearSlider1b" min="0" max="7" value="0">
              <span class="slider-label">2021</span>
            </div>
          </div>
          <div id="treemap1b"></div>
          
          <!-- LEGENDA -->
          <div class="color-legend">
            <span class="legend-title">Legenda:</span>
            <div class="legend-scale">
              <div class="legend-box" style="background: #f7fbff"></div>
              <span class="legend-label">&lt; 70k</span>
              <div class="legend-box" style="background: #6baed6"></div>
              <span class="legend-label">120k-250k</span>
              <div class="legend-box" style="background: #084594"></div>
              <span class="legend-label">350k+</span>
            </div>
          </div>
        </div>

        <!-- PAINEL DIREITO: MAPA -->
        <div class="split-panel">
          <h3>üó∫Ô∏è Mapa Coropl√©tico</h3>
          <iframe src="coropletico_iframe.html" class="map-iframe"></iframe>
        </div>
      </div>
    </div>

    <!-- SUB-TAB 1C: GR√ÅFICO DE BARRAS -->
    <div class="sub-content" id="subtab1c">
      <div class="container">
        <div class="controls">
          <div class="year-display" id="yearDisplay1c">1940</div>
          <div class="nav-buttons">
            <button id="prevBtn1c" class="btn-primary">‚óÑ</button>
            <select id="yearSelect1c"></select>
            <button id="nextBtn1c" class="btn-primary">‚ñ∫</button>
          </div>
          <div class="slider-container">
            <span class="slider-label">1940</span>
            <input type="range" id="yearSlider1c" min="0" max="7" value="0">
            <span class="slider-label">2021</span>
          </div>
        </div>
        <div id="barchart" style="width: 100%; height: 600px;"></div>
        
        <!-- LEGENDA -->
        <div class="color-legend">
          <span class="legend-title">Legenda:</span>
          <div class="legend-scale">
            <div class="legend-box" style="background: #f7fbff"></div>
            <span class="legend-label">&lt; 70k</span>
            <div class="legend-box" style="background: #6baed6"></div>
            <span class="legend-label">120k-250k</span>
            <div class="legend-box" style="background: #084594"></div>
            <span class="legend-label">350k+</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 2: PERDA DE GEORREFER√äNCIA -->
  <div class="tab-content" id="tab2">
    <div class="source-box">
      <strong>üéØ Objetivo:</strong> Avaliar o que se perde ao eliminar a posi√ß√£o geogr√°fica
    </div>

    <div class="split-view">
      <!-- PAINEL ESQUERDO: TREEMAP -->
      <div class="split-panel">
        <h3>üß© Treemap</h3>
        <div class="controls">
          <div class="year-display" id="yearDisplay2">1940</div>
          <div class="nav-buttons">
            <button id="prevBtn2" class="btn-primary">‚óÑ</button>
            <select id="yearSelect2"></select>
            <button id="nextBtn2" class="btn-primary">‚ñ∫</button>
          </div>
          <div class="slider-container">
            <span class="slider-label">1940</span>
            <input type="range" id="yearSlider2" min="0" max="7" value="0">
            <span class="slider-label">2021</span>
          </div>
        </div>
        <div id="treemap2"></div>
        
        <!-- LEGENDA -->
        <div class="color-legend">
          <span class="legend-title">Legenda:</span>
          <div class="legend-scale">
            <div class="legend-box" style="background: #f7fbff"></div>
            <span class="legend-label">&lt; 70k</span>
            <div class="legend-box" style="background: #6baed6"></div>
            <span class="legend-label">120k-250k</span>
            <div class="legend-box" style="background: #084594"></div>
            <span class="legend-label">350k+</span>
          </div>
        </div>
      </div>

      <!-- PAINEL DIREITO: MAPA -->
      <div class="split-panel">
        <h3>üó∫Ô∏è Mapa Coropl√©tico</h3>
        <iframe src="coropletico_iframe.html" class="map-iframe"></iframe>
      </div>
    </div>

    <!-- CAIXA DE AN√ÅLISE -->
    <div class="analysis-box">
      <h3>üìä An√°lise Comparativa: Treemap vs Mapa Coropl√©tico</h3>
      
      <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Comparar anos:</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="compareYear1" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
              <option value="1940">1940</option>
              <option value="1950">1950</option>
              <option value="1960">1960</option>
              <option value="1981">1981</option>
              <option value="1991">1991</option>
              <option value="2001">2001</option>
              <option value="2011">2011</option>
              <option value="2021" selected>2021</option>
            </select>
            <span>vs</span>
            <select id="compareYear2" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
              <option value="1940" selected>1940</option>
              <option value="1950">1950</option>
              <option value="1960">1960</option>
              <option value="1981">1981</option>
              <option value="1991">1991</option>
              <option value="2001">2001</option>
              <option value="2011">2011</option>
              <option value="2021">2021</option>
            </select>
          </div>
        </div>
        <button onclick="compararAnos()" style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 20px;">
          üîç Comparar
        </button>
      </div>
      
      <div id="resultadoComparacao" style="display: none; padding: 15px; background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196f3; border-radius: 4px; margin-bottom: 20px;">
        <!-- Resultado da compara√ß√£o aparece aqui -->
      </div>
      
      <div id="textoAnalise">
        <p style="margin-bottom: 15px; font-style: italic;">
          Compare as duas visualiza√ß√µes acima e observe as diferen√ßas fundamentais na perce√ß√£o dos dados:
        </p>
        
        <h4 style="margin-top: 15px; color: #d32f2f;">‚ùå O que o TREEMAP perde (ao eliminar georrefer√™ncia):</h4>
        <ul style="margin-bottom: 20px;" id="perdasLista">
          <li><strong>Distribui√ß√£o geogr√°fica:</strong> No mapa v√™-se claramente que o Norte (Porto, Braga) √© densamente povoado. No treemap, esta concentra√ß√£o geogr√°fica desaparece.</li>
          <li><strong>Padr√µes espaciais:</strong> O mapa mostra o litoral mais povoado que o interior. No treemap, distritos costeiros e interiores misturam-se sem distin√ß√£o.</li>
          <li><strong>Vizinhan√ßa:</strong> No mapa, Lisboa est√° junto a Set√∫bal e Santar√©m. No treemap, podem aparecer separados por distritos de outras regi√µes.</li>
          <li><strong>Contexto territorial:</strong> O mapa preserva a forma real dos distritos. No treemap, todos s√£o ret√¢ngulos proporcionais.</li>
        </ul>
        
        <h4 style="margin-top: 15px; color: #2e7d32;">‚úÖ O que o TREEMAP ganha (ao eliminar georrefer√™ncia):</h4>
        <ul id="ganhosLista">
          <li><strong>Compara√ß√£o precisa de magnitudes:</strong> Lisboa tem √°rea geogr√°fica pequena mas muitas habita√ß√µes ‚Äî no mapa parece pequena, no treemap o seu tamanho real √© evidente.</li>
          <li><strong>Hierarquiza√ß√£o visual:</strong> Distritos mais importantes (mais habita√ß√µes) ocupam mais espa√ßo visual, independentemente da sua √°rea territorial.</li>
          <li><strong>Foco nos valores:</strong> Elimina a distra√ß√£o da geografia, permitindo comparar diretamente Lisboa vs Porto vs Set√∫bal.</li>
          <li><strong>Efici√™ncia de espa√ßo:</strong> Usa 100% da √°rea dispon√≠vel para representar dados, sem "espa√ßos vazios" (mar, fronteiras).</li>
        </ul>
      </div>
      
      <h4 style="margin-top: 20px; color: #1565c0;">üéØ Conclus√£o:</h4>
      <p style="margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.3); border-left: 4px solid #1976d2; border-radius: 4px;">
        <strong>Use o MAPA</strong> quando a localiza√ß√£o geogr√°fica for relevante (an√°lise regional, proximidade, padr√µes espaciais).<br>
        <strong>Use o TREEMAP</strong> quando quiser comparar magnitudes absolutas sem o "ru√≠do" da geografia (rankings, propor√ß√µes, hierarquias).
      </p>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// ============================================================================
// DADOS E CONFIGURA√á√ÉO
// ============================================================================

const anos = [1940, 1950, 1960, 1981, 1991, 2001, 2011, 2021];

const coresNUTS = {
  'Norte': '#e74c3c',
  'Centro': '#3498db',
  'Lisboa': '#2ecc71',
  'Alentejo': '#f39c12',
  'Algarve': '#9b59b6',
  'A√ßores': '#1abc9c',
  'Madeira': '#e67e22'
};

const distritoNUTS = {
  'Aveiro': 'Centro', 'Beja': 'Alentejo', 'Braga': 'Norte',
  'Bragan√ßa': 'Norte', 'Castelo Branco': 'Centro', 'Coimbra': 'Centro',
  '√âvora': 'Alentejo', 'Faro': 'Algarve', 'Guarda': 'Centro',
  'Leiria': 'Centro', 'Lisboa': 'Lisboa', 'Portalegre': 'Alentejo',
  'Porto': 'Norte', 'Santar√©m': 'Lisboa', 'Set√∫bal': 'Lisboa',
  'Viana do Castelo': 'Norte', 'Vila Real': 'Norte', 'Viseu': 'Centro',
  'R. A. A√ßores': 'A√ßores', 'R. A. Madeira': 'Madeira'
};

// Fun√ß√£o para obter cor por gradiente baseado no valor
function getColorByValue(value) {
  // ATUALIZADO: Escala Blues EXATAMENTE igual ao mapa do Andr√©
  const blues = [
    '#deebf7', // 70k-90k
    '#c6dbef', // 90k-120k
    '#9ecae1', // 120k-180k
    '#6baed6', // 180k-250k
    '#4292c6', // 250k-350k
    '#2171b5', // 350k-500k
    '#084594'  // 500k+
  ];
  
  return value > 500000 ? blues[6] :
         value > 350000 ? blues[5] :
         value > 250000 ? blues[4] :
         value > 180000 ? blues[3] :
         value > 120000 ? blues[2] :
         value > 90000  ? blues[1] :
                          blues[0];
}

let dadosOriginais = null;
let instances = {};

// ============================================================================
// SISTEMA DE TABS
// ============================================================================

function switchMainTab(index) {
  const tabs = document.querySelectorAll('.main-tab');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach((tab, i) => {
    if (i === index) {
      tab.classList.add('active');
      contents[i].classList.add('active');
    } else {
      tab.classList.remove('active');
      contents[i].classList.remove('active');
    }
  });
  
  // FIX: Redesenhar treemap ao mudar para TAB 2
  if (index === 1 && instances['2']) {
    setTimeout(() => {
      instances['2'].desenharTreemap();
    }, 100);
  }
}

function switchSubTab(index) {
  const subTabs = document.querySelectorAll('.sub-tab');
  const subContents = document.querySelectorAll('.sub-content');
  
  subTabs.forEach((tab, i) => {
    if (i === index) {
      tab.classList.add('active');
      subContents[i].classList.add('active');
    } else {
      tab.classList.remove('active');
      subContents[i].classList.remove('active');
    }
  });
  
  // Redesenhar quando muda de sub-tab
  if (index === 0 && instances['1a']) {
    setTimeout(() => instances['1a'].update(), 100);
  } else if (index === 1 && instances['1b']) {
    setTimeout(() => instances['1b'].update(), 100);
  } else if (index === 2 && instances['1c']) {
    setTimeout(() => instances['1c'].desenharBarChart(), 100);
  }
}

// ============================================================================
// CLASSE TREEMAP INSTANCE
// ============================================================================

class TreemapInstance {
  constructor(id, containerId) {
    this.id = id;
    this.containerId = containerId;
    this.currentYearIndex = 0;
    this.isPlaying = false;
    this.playSpeed = 1500;
    this.playInterval = null;
    
    this.yearDisplay = document.getElementById(`yearDisplay${id}`);
    this.yearSlider = document.getElementById(`yearSlider${id}`);
    this.yearSelect = document.getElementById(`yearSelect${id}`);
    this.prevBtn = document.getElementById(`prevBtn${id}`);
    this.nextBtn = document.getElementById(`nextBtn${id}`);
    this.playBtn = document.getElementById(`playBtn${id}`);
    this.resetBtn = document.getElementById(`resetBtn${id}`);
    
    this.setupControls();
  }
  
  setupControls() {
    // Popular dropdown
    if (this.yearSelect) {
      anos.forEach((ano, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = ano;
        this.yearSelect.appendChild(option);
      });
    }
    
    // Event listeners
    if (this.yearSlider) {
      this.yearSlider.addEventListener('input', (e) => {
        this.currentYearIndex = parseInt(e.target.value);
        this.update();
      });
    }
    
    if (this.yearSelect) {
      this.yearSelect.addEventListener('change', (e) => {
        this.currentYearIndex = parseInt(e.target.value);
        this.update();
      });
    }
    
    if (this.prevBtn) {
      this.prevBtn.addEventListener('click', () => {
        if (this.currentYearIndex > 0) {
          this.currentYearIndex--;
          this.update();
        }
      });
    }
    
    if (this.nextBtn) {
      this.nextBtn.addEventListener('click', () => {
        if (this.currentYearIndex < anos.length - 1) {
          this.currentYearIndex++;
          this.update();
        }
      });
    }
    
    if (this.playBtn) {
      this.playBtn.addEventListener('click', () => {
        if (this.isPlaying) {
          this.stop();
        } else {
          this.play();
        }
      });
    }
    
    if (this.resetBtn) {
      this.resetBtn.addEventListener('click', () => {
        this.stop();
        this.currentYearIndex = 0;
        this.update();
      });
    }
    
    // Speed controls (apenas para 1a que tem todos os controlos)
    if (this.id === '1a') {
      const speedBtns = document.querySelectorAll('.speed-btn');
      speedBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          speedBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          this.playSpeed = parseInt(btn.dataset.speed);
          
          if (this.isPlaying) {
            this.stop();
            this.play();
          }
        });
      });
    }
  }
  
  update() {
    // Atualizar ano display
    if (this.yearDisplay) {
      this.yearDisplay.textContent = anos[this.currentYearIndex];
    }
    
    // Atualizar slider
    if (this.yearSlider) {
      this.yearSlider.value = this.currentYearIndex;
    }
    
    // Atualizar select
    if (this.yearSelect) {
      this.yearSelect.value = this.currentYearIndex;
    }
    
    // Atualizar bot√µes
    if (this.prevBtn) {
      this.prevBtn.disabled = this.currentYearIndex === 0;
    }
    if (this.nextBtn) {
      this.nextBtn.disabled = this.currentYearIndex === anos.length - 1;
    }
    
    // Redesenhar treemap
    this.desenharTreemap();
    
    // Se for inst√¢ncia do TAB 2, atualizar an√°lise automaticamente
    if (this.id === '2') {
      atualizarAnaliseAutomatica();
    }
  }
  
  play() {
    this.isPlaying = true;
    if (this.playBtn) {
      this.playBtn.innerHTML = '‚è∏ Pausa';
      this.playBtn.classList.remove('btn-primary');
      this.playBtn.classList.add('btn-secondary');
    }
    
    this.playInterval = setInterval(() => {
      this.currentYearIndex++;
      if (this.currentYearIndex >= anos.length) {
        this.currentYearIndex = 0;
      }
      this.update();
    }, this.playSpeed);
  }
  
  stop() {
    this.isPlaying = false;
    if (this.playBtn) {
      this.playBtn.innerHTML = '‚ñ∂ Reproduzir Evolu√ß√£o';
      this.playBtn.classList.remove('btn-secondary');
      this.playBtn.classList.add('btn-primary');
    }
    if (this.playInterval) {
      clearInterval(this.playInterval);
      this.playInterval = null;
    }
  }
  
  desenharTreemap() {
    const container = document.getElementById(this.containerId);
    if (!container || !dadosOriginais) return;
    
    const anoAtual = anos[this.currentYearIndex];
    const dadosAno = dadosOriginais[anoAtual];
    
    // Limpar SVG anterior
    d3.select(`#${this.containerId}`).selectAll('*').remove();
    
    // Criar hierarquia por regi√£o
    const dadosPorRegiao = {};
    Object.entries(dadosAno).forEach(([distrito, valor]) => {
      const regiao = distritoNUTS[distrito] || 'Outro';
      if (!dadosPorRegiao[regiao]) {
        dadosPorRegiao[regiao] = [];
      }
      dadosPorRegiao[regiao].push({ name: distrito, value: valor });
    });
    
    const hierarquia = {
      name: 'Portugal',
      children: Object.entries(dadosPorRegiao).map(([regiao, distritos]) => ({
        name: regiao,
        children: distritos
      }))
    };
    
    // Dimens√µes
    const width = container.offsetWidth;
    const height = 600;
    
    // Criar SVG
    const svg = d3.select(`#${this.containerId}`)
      .append('svg')
      .attr('width', width)
      .attr('height', height);
    
    // Treemap layout
    const root = d3.hierarchy(hierarquia)
      .sum(d => d.value)
      .sort((a, b) => b.value - a.value);
    
    d3.treemap()
      .size([width, height])
      .paddingOuter(3)
      .paddingTop(20)
      .paddingInner(2)
      .round(true)(root);
    
    // Tooltip
    const tooltip = d3.select('#tooltip');
    
    // Grupos
    const grupos = svg.selectAll('g')
      .data(root.leaves())
      .enter()
      .append('g')
      .attr('transform', d => `translate(${d.x0},${d.y0})`);
    
    // Ret√¢ngulos
    grupos.append('rect')
      .attr('width', d => d.x1 - d.x0)
      .attr('height', d => d.y1 - d.y0)
      .attr('fill', d => getColorByValue(d.value))
      .attr('stroke', '#fff')
      .attr('stroke-width', 2)
      .style('opacity', 0.85)
      .on('mouseover', function(event, d) {
        d3.select(this).style('opacity', 1);
        const regiao = d.parent.data.name;
        tooltip
          .style('opacity', 1)
          .html(`
            <div class="tooltip-title">${d.data.name}</div>
            <div class="tooltip-content">
              <strong>Regi√£o:</strong> ${regiao}<br>
              <strong>Ano:</strong> ${anoAtual}<br>
              <strong>Habita√ß√µes:</strong> ${d.value.toLocaleString('pt-PT')}
            </div>
          `)
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px');
      })
      .on('mouseout', function() {
        d3.select(this).style('opacity', 0.85);
        tooltip.style('opacity', 0);
      });
    
    // Texto
    grupos.append('text')
      .attr('x', d => (d.x1 - d.x0) / 2)
      .attr('y', d => (d.y1 - d.y0) / 2)
      .attr('text-anchor', 'middle')
      .attr('dominant-baseline', 'middle')
      .attr('fill', '#fff')
      .attr('font-size', d => {
        const width = d.x1 - d.x0;
        const height = d.y1 - d.y0;
        const area = width * height;
        // Calcular tamanho baseado em √°rea, mais generoso
        const size = Math.min(16, Math.max(7, Math.sqrt(area) / 12));
        return size + 'px';
      })
      .attr('font-weight', '700')
      .style('pointer-events', 'none')
      .style('text-shadow', '0 0 3px rgba(0,0,0,0.8), 0 0 5px rgba(0,0,0,0.6)')
      .text(d => {
        const width = d.x1 - d.x0;
        const height = d.y1 - d.y0;
        // MELHORADO: Mostrar nome se tiver espa√ßo m√≠nimo (reduzido para 25x15)
        if (width < 25 || height < 15) return '';
        
        // Para nomes longos, abreviar se necess√°rio
        const nome = d.data.name;
        if (width < 50 && nome.length > 8) {
          return nome.substring(0, 5) + '.';
        }
        if (width < 70 && nome.length > 10) {
          return nome.substring(0, 8) + '.';
        }
        return nome;
      });
  }
}

// ============================================================================
// FUN√á√ÉO DE COMPARA√á√ÉO DE ANOS
// ============================================================================

// ============================================================================
// ATUALIZA√á√ÉO AUTOM√ÅTICA DA AN√ÅLISE (TAB 2)
// ============================================================================

function atualizarAnaliseAutomatica() {
  // Pegar ano atual do TAB 2
  const anoAtualIndex = instances['2'].currentYearIndex;
  const anoAtual = anos[anoAtualIndex];
  
  // Comparar sempre com o primeiro ano (1940) ou ano anterior se for o primeiro
  const anoBaseIndex = anoAtualIndex > 0 ? 0 : 0;
  const anoBase = anos[anoBaseIndex];
  
  // Se for o mesmo ano, n√£o faz sentido comparar
  if (anoAtual === anoBase) {
    // Mostrar texto gen√©rico inicial
    mostrarTextoGenerico();
    return;
  }
  
  // Atualizar os dropdowns silenciosamente
  const select1 = document.getElementById('compareYear1');
  const select2 = document.getElementById('compareYear2');
  if (select1 && select2) {
    select2.value = anoAtual;
    select1.value = anoBase;
  }
  
  // Chamar a compara√ß√£o sem mostrar o resultado num√©rico
  compararAnosSilencioso(anoBase, anoAtual);
}

function mostrarTextoGenerico() {
  const perdasLista = document.getElementById('perdasLista');
  const ganhosLista = document.getElementById('ganhosLista');
  
  perdasLista.innerHTML = `
    <li><strong>Distribui√ß√£o geogr√°fica:</strong> No mapa v√™-se claramente que o Norte (Porto, Braga) √© densamente povoado. No treemap, esta concentra√ß√£o geogr√°fica desaparece.</li>
    <li><strong>Padr√µes espaciais:</strong> O mapa mostra o litoral mais povoado que o interior. No treemap, distritos costeiros e interiores misturam-se sem distin√ß√£o.</li>
    <li><strong>Vizinhan√ßa:</strong> No mapa, Lisboa est√° junto a Set√∫bal e Santar√©m. No treemap, podem aparecer separados por distritos de outras regi√µes.</li>
    <li><strong>Contexto territorial:</strong> O mapa preserva a forma real dos distritos. No treemap, todos s√£o ret√¢ngulos proporcionais.</li>
  `;
  
  ganhosLista.innerHTML = `
    <li><strong>Compara√ß√£o precisa de magnitudes:</strong> Lisboa tem √°rea geogr√°fica pequena mas muitas habita√ß√µes ‚Äî no mapa parece pequena, no treemap o seu tamanho real √© evidente.</li>
    <li><strong>Hierarquiza√ß√£o visual:</strong> Distritos mais importantes (mais habita√ß√µes) ocupam mais espa√ßo visual, independentemente da sua √°rea territorial.</li>
    <li><strong>Foco nos valores:</strong> Elimina a distra√ß√£o da geografia, permitindo comparar diretamente Lisboa vs Porto vs Set√∫bal.</li>
    <li><strong>Efici√™ncia de espa√ßo:</strong> Usa 100% da √°rea dispon√≠vel para representar dados, sem "espa√ßos vazios" (mar, fronteiras).</li>
  `;
}

function compararAnosSilencioso(ano1, ano2) {
  const dados1 = dadosOriginais[ano1];
  const dados2 = dadosOriginais[ano2];
  
  if (!dados1 || !dados2) return;
  
  // Calcular totais
  let total1 = 0, total2 = 0;
  Object.values(dados1).forEach(v => total1 += v);
  Object.values(dados2).forEach(v => total2 += v);
  
  // Encontrar maior crescimento
  let maiorCrescimento = { distrito: '', valor: 0, perc: 0 };
  
  Object.keys(dados1).forEach(distrito => {
    if (dados2[distrito]) {
      const crescimento = dados2[distrito] - dados1[distrito];
      const percCrescimento = ((dados2[distrito] / dados1[distrito]) - 1) * 100;
      
      if (crescimento > maiorCrescimento.valor) {
        maiorCrescimento = { distrito, valor: crescimento, perc: percCrescimento };
      }
    }
  });
  
  // Top 3 distritos em cada ano
  const top1 = Object.entries(dados1).sort((a,b) => b[1] - a[1]).slice(0, 3);
  const top2 = Object.entries(dados2).sort((a,b) => b[1] - a[1]).slice(0, 3);
  
  // Atualizar apenas o texto (sem mostrar caixa de resultado)
  atualizarTextoAnalise(ano1, ano2, dados1, dados2, total1, total2, top1, top2, maiorCrescimento);
}

function atualizarTextoAnalise(ano1, ano2, dados1, dados2, total1, total2, top1, top2, maiorCrescimento) {
  const perdasLista = document.getElementById('perdasLista');
  const ganhosLista = document.getElementById('ganhosLista');
  
  // Identificar mudan√ßas no top 3
  const distritos1Set = new Set(top1.map(([d]) => d));
  const distritos2Set = new Set(top2.map(([d]) => d));
  const novosNoTop = top2.filter(([d]) => !distritos1Set.has(d)).map(([d]) => d);
  const sairamDoTop = top1.filter(([d]) => !distritos2Set.has(d)).map(([d]) => d);
  
  // Calcular concentra√ß√£o Norte
  const norte = ['Porto', 'Braga', 'Viana do Castelo', 'Vila Real', 'Bragan√ßa'];
  const totalNorte1 = norte.reduce((sum, d) => sum + (dados1[d] || 0), 0);
  const totalNorte2 = norte.reduce((sum, d) => sum + (dados2[d] || 0), 0);
  const percNorte1 = (totalNorte1 / total1 * 100).toFixed(1);
  const percNorte2 = (totalNorte2 / total2 * 100).toFixed(1);
  
  // Identificar distritos costeiros vs interior
  const costeiros = ['Lisboa', 'Porto', 'Set√∫bal', 'Aveiro', 'Faro', 'Braga', 'Viana do Castelo'];
  const totalCosta1 = costeiros.reduce((sum, d) => sum + (dados1[d] || 0), 0);
  const totalCosta2 = costeiros.reduce((sum, d) => sum + (dados2[d] || 0), 0);
  const percCosta1 = (totalCosta1 / total1 * 100).toFixed(1);
  const percCosta2 = (totalCosta2 / total2 * 100).toFixed(1);
  
  perdasLista.innerHTML = `
    <li><strong>Distribui√ß√£o geogr√°fica:</strong> No mapa v√™-se que em ${ano1} o Norte tinha ${percNorte1}% das habita√ß√µes, e em ${ano2} tem ${percNorte2}%. ${parseFloat(percNorte2) > parseFloat(percNorte1) ? 'Cresceu' : 'Diminuiu'} ${Math.abs(percNorte2 - percNorte1).toFixed(1)}pp. No treemap, esta evolu√ß√£o regional n√£o √© vis√≠vel ‚Äî s√≥ v√™ √°reas maiores ou menores.</li>
    
    <li><strong>Padr√µes espaciais:</strong> O mapa mostra que em ${ano1} o litoral tinha ${percCosta1}% e em ${ano2} tem ${percCosta2}% (${parseFloat(percCosta2) > parseFloat(percCosta1) ? '+' : ''}${(percCosta2 - percCosta1).toFixed(1)}pp). No treemap, distritos costeiros e interiores misturam-se ‚Äî imposs√≠vel ver este padr√£o litoral vs interior.</li>
    
    <li><strong>Vizinhan√ßa:</strong> No mapa, Lisboa (${dados1['Lisboa']?.toLocaleString('pt-PT')} ‚Üí ${dados2['Lisboa']?.toLocaleString('pt-PT')}) est√° sempre junto a Set√∫bal (${dados1['Set√∫bal']?.toLocaleString('pt-PT')} ‚Üí ${dados2['Set√∫bal']?.toLocaleString('pt-PT')}). No treemap, podem aparecer separados por ${maiorCrescimento.distrito} ou outros ‚Äî perdeu-se a proximidade geogr√°fica real.</li>
    
    <li><strong>Contexto territorial:</strong> O mapa preserva que ${top2[0][0]} √© sempre pequeno geograficamente mas muito povoado. No treemap de ${ano1}, ${top1[0][0]} era o maior ret√¢ngulo; em ${ano2}, ${top2[0][0]} √© o maior ‚Äî mas ambos s√£o ret√¢ngulos gen√©ricos, n√£o a forma real do distrito.</li>
  `;
  
  // Comparar Lisboa vs Porto
  const lisboaGrowth = dados1['Lisboa'] && dados2['Lisboa'] ? 
    ((dados2['Lisboa'] / dados1['Lisboa'] - 1) * 100).toFixed(1) : 0;
  const portoGrowth = dados1['Porto'] && dados2['Porto'] ? 
    ((dados2['Porto'] / dados1['Porto'] - 1) * 100).toFixed(1) : 0;
  
  ganhosLista.innerHTML = `
    <li><strong>Compara√ß√£o precisa de magnitudes:</strong> No mapa, Lisboa parece pequena nos 2 anos (√°rea geogr√°fica reduzida). No treemap v√™-se claramente: em ${ano1} tinha ${dados1['Lisboa']?.toLocaleString('pt-PT')} hab, em ${ano2} tem ${dados2['Lisboa']?.toLocaleString('pt-PT')} (${lisboaGrowth > 0 ? '+' : ''}${lisboaGrowth}%) ‚Äî o ret√¢ngulo cresceu proporcionalmente.</li>
    
    <li><strong>Hierarquiza√ß√£o visual:</strong> Em ${ano1}: ${top1.map(([d,v], i) => `${i+1}¬∫ ${d} (${v.toLocaleString('pt-PT')})`).join(', ')}. Em ${ano2}: ${top2.map(([d,v], i) => `${i+1}¬∫ ${d} (${v.toLocaleString('pt-PT')})`).join(', ')}. ${novosNoTop.length > 0 ? `${novosNoTop[0]} entrou no top 3, ` : ''}${sairamDoTop.length > 0 ? `${sairamDoTop[0]} saiu. ` : ''}No treemap, estas mudan√ßas de ranking s√£o imediatamente vis√≠veis pelo tamanho dos ret√¢ngulos.</li>
    
    <li><strong>Foco nos valores:</strong> Compara√ß√£o direta: Lisboa cresceu ${lisboaGrowth}% vs Porto ${portoGrowth}%. ${Math.abs(lisboaGrowth) > Math.abs(portoGrowth) ? 'Lisboa cresceu mais r√°pido' : 'Porto cresceu mais r√°pido'} entre ${ano1} e ${ano2}. No treemap v√™-se isto pelo crescimento relativo das √°reas. No mapa, esta compara√ß√£o √© dif√≠cil porque Lisboa tem √°rea geogr√°fica pequena.</li>
    
    <li><strong>Efici√™ncia de espa√ßo:</strong> Em ${ano1} havia ${Object.keys(dados1).length} distritos com dados; em ${ano2} s√£o ${Object.keys(dados2).length}. O treemap usa 100% da √°rea para mostrar todos. O mapa tem ${((1 - (Object.keys(dados2).length * 0.01)) * 100).toFixed(0)}% de "espa√ßos vazios" (mar, fronteiras) que n√£o representam esta evolu√ß√£o.</li>
  `;
}

// ============================================================================
// FUN√á√ÉO DE COMPARA√á√ÉO MANUAL (BOT√ÉO)
// ============================================================================

function compararAnos() {
  const ano1 = parseInt(document.getElementById('compareYear1').value);
  const ano2 = parseInt(document.getElementById('compareYear2').value);
  
  if (ano1 === ano2) {
    alert('Por favor selecione anos diferentes para comparar');
    return;
  }
  
  const dados1 = dadosOriginais[ano1];
  const dados2 = dadosOriginais[ano2];
  
  if (!dados1 || !dados2) {
    alert('Dados n√£o dispon√≠veis para os anos selecionados');
    return;
  }
  
  // Calcular totais
  let total1 = 0, total2 = 0;
  Object.values(dados1).forEach(v => total1 += v);
  Object.values(dados2).forEach(v => total2 += v);
  
  // Encontrar maior crescimento
  let maiorCrescimento = { distrito: '', valor: 0, perc: 0 };
  let menorCrescimento = { distrito: '', valor: Infinity, perc: 0 };
  
  Object.keys(dados1).forEach(distrito => {
    if (dados2[distrito]) {
      const crescimento = dados2[distrito] - dados1[distrito];
      const percCrescimento = ((dados2[distrito] / dados1[distrito]) - 1) * 100;
      
      if (crescimento > maiorCrescimento.valor) {
        maiorCrescimento = { distrito, valor: crescimento, perc: percCrescimento };
      }
      if (crescimento < menorCrescimento.valor) {
        menorCrescimento = { distrito, valor: crescimento, perc: percCrescimento };
      }
    }
  });
  
  // Top 3 distritos em cada ano
  const top1 = Object.entries(dados1).sort((a,b) => b[1] - a[1]).slice(0, 3);
  const top2 = Object.entries(dados2).sort((a,b) => b[1] - a[1]).slice(0, 3);
  
  // Varia√ß√£o total
  const variacaoTotal = ((total2 / total1) - 1) * 100;
  
  // Montar resultado
  const resultado = document.getElementById('resultadoComparacao');
  resultado.style.display = 'block';
  resultado.innerHTML = `
    <h4 style="margin-top: 0; color: #1565c0;">üìà Compara√ß√£o ${ano1} vs ${ano2}</h4>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
      <div>
        <strong>Total ${ano1}:</strong> ${total1.toLocaleString('pt-PT')} habita√ß√µes<br>
        <strong>Top 3:</strong>
        <ol style="margin: 5px 0 0 20px;">
          ${top1.map(([d,v]) => `<li>${d}: ${v.toLocaleString('pt-PT')}</li>`).join('')}
        </ol>
      </div>
      <div>
        <strong>Total ${ano2}:</strong> ${total2.toLocaleString('pt-PT')} habita√ß√µes<br>
        <strong>Top 3:</strong>
        <ol style="margin: 5px 0 0 20px;">
          ${top2.map(([d,v]) => `<li>${d}: ${v.toLocaleString('pt-PT')}</li>`).join('')}
        </ol>
      </div>
    </div>
    
    <div style="background: rgba(255,255,255,0.5); padding: 10px; border-radius: 4px; margin-top: 10px;">
      <strong>üìä Varia√ß√£o total:</strong> ${variacaoTotal > 0 ? '+' : ''}${variacaoTotal.toFixed(1)}% 
      (${(total2 - total1).toLocaleString('pt-PT')} habita√ß√µes)<br>
      
      <strong style="color: #2e7d32;">üîù Maior crescimento:</strong> ${maiorCrescimento.distrito} 
      (+${maiorCrescimento.valor.toLocaleString('pt-PT')} hab, +${maiorCrescimento.perc.toFixed(1)}%)<br>
      
      ${menorCrescimento.valor < 0 ? 
        `<strong style="color: #d32f2f;">üìâ Maior decr√©scimo:</strong> ${menorCrescimento.distrito} 
        (${menorCrescimento.valor.toLocaleString('pt-PT')} hab, ${menorCrescimento.perc.toFixed(1)}%)` : ''}
    </div>
    
    <p style="margin-top: 10px; font-size: 14px; font-style: italic;">
      üí° <strong>Nota:</strong> No treemap, ${maiorCrescimento.distrito} aparece maior em ${ano2}. 
      No mapa, pode ver onde ${maiorCrescimento.distrito} est√° localizado geograficamente.
    </p>
  `;
  
  // Atualizar texto da an√°lise usando a fun√ß√£o auxiliar
  atualizarTextoAnalise(ano1, ano2, dados1, dados2, total1, total2, top1, top2, maiorCrescimento);
  
  // Scroll suave at√© ao resultado
  resultado.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ============================================================================
// CLASSE BARCHART INSTANCE
// ============================================================================

class BarChartInstance {
  constructor(id) {
    this.id = id;
    this.currentYearIndex = 0;
    
    this.yearDisplay = document.getElementById(`yearDisplay${id}`);
    this.yearSlider = document.getElementById(`yearSlider${id}`);
    this.yearSelect = document.getElementById(`yearSelect${id}`);
    this.prevBtn = document.getElementById(`prevBtn${id}`);
    this.nextBtn = document.getElementById(`nextBtn${id}`);
    
    this.setupControls();
  }
  
  setupControls() {
    // Popular dropdown
    if (this.yearSelect) {
      anos.forEach((ano, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = ano;
        this.yearSelect.appendChild(option);
      });
    }
    
    // Event listeners
    if (this.yearSlider) {
      this.yearSlider.addEventListener('input', (e) => {
        this.currentYearIndex = parseInt(e.target.value);
        this.update();
      });
    }
    
    if (this.yearSelect) {
      this.yearSelect.addEventListener('change', (e) => {
        this.currentYearIndex = parseInt(e.target.value);
        this.update();
      });
    }
    
    if (this.prevBtn) {
      this.prevBtn.addEventListener('click', () => {
        if (this.currentYearIndex > 0) {
          this.currentYearIndex--;
          this.update();
        }
      });
    }
    
    if (this.nextBtn) {
      this.nextBtn.addEventListener('click', () => {
        if (this.currentYearIndex < anos.length - 1) {
          this.currentYearIndex++;
          this.update();
        }
      });
    }
  }
  
  update() {
    const anoAtual = anos[this.currentYearIndex];
    
    if (this.yearDisplay) this.yearDisplay.textContent = anoAtual;
    if (this.yearSlider) this.yearSlider.value = this.currentYearIndex;
    if (this.yearSelect) this.yearSelect.value = this.currentYearIndex;
    
    this.desenharBarChart();
  }
  
  desenharBarChart() {
    const anoAtual = anos[this.currentYearIndex];
    const dados = dadosOriginais[anoAtual];
    
    if (!dados) return;
    
    // Preparar dados ordenados
    const dadosOrdenados = Object.entries(dados)
      .map(([distrito, habitacoes]) => ({
        distrito,
        habitacoes,
        regiao: distritoNUTS[distrito] || 'Outro'
      }))
      .sort((a, b) => b.habitacoes - a.habitacoes);
    
    // Limpar container
    const container = d3.select('#barchart');
    container.selectAll('*').remove();
    
    const containerNode = document.getElementById('barchart');
    if (!containerNode) return;
    
    const width = containerNode.clientWidth;
    const height = 600;
    const margin = { top: 20, right: 30, bottom: 120, left: 60 };
    
    const svg = container.append('svg')
      .attr('width', width)
      .attr('height', height);
    
    const g = svg.append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);
    
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;
    
    // Escalas
    const x = d3.scaleBand()
      .domain(dadosOrdenados.map(d => d.distrito))
      .range([0, chartWidth])
      .padding(0.2);
    
    const y = d3.scaleLinear()
      .domain([0, d3.max(dadosOrdenados, d => d.habitacoes)])
      .nice()
      .range([chartHeight, 0]);
    
    // Eixos
    g.append('g')
      .attr('transform', `translate(0,${chartHeight})`)
      .call(d3.axisBottom(x))
      .selectAll('text')
      .attr('transform', 'rotate(-45)')
      .style('text-anchor', 'end')
      .style('font-size', '12px');
    
    g.append('g')
      .call(d3.axisLeft(y).tickFormat(d => d.toLocaleString('pt-PT')))
      .style('font-size', '12px');
    
    // Barras
    g.selectAll('.bar')
      .data(dadosOrdenados)
      .enter()
      .append('rect')
      .attr('class', 'bar')
      .attr('x', d => x(d.distrito))
      .attr('y', d => y(d.habitacoes))
      .attr('width', x.bandwidth())
      .attr('height', d => chartHeight - y(d.habitacoes))
      .attr('fill', d => getColorByValue(d.habitacoes))
      .attr('stroke', '#fff')
      .attr('stroke-width', 1)
      .style('opacity', 0.85)
      .on('mouseover', function(event, d) {
        d3.select(this).style('opacity', 1);
        
        const tooltip = d3.select('#tooltip');
        tooltip.style('opacity', 1)
          .html(`
            <div class="tooltip-title">${d.distrito}</div>
            <div class="tooltip-content">
              <strong>Regi√£o:</strong> ${d.regiao}<br>
              <strong>Ano:</strong> ${anoAtual}<br>
              <strong>Habita√ß√µes:</strong> ${d.habitacoes.toLocaleString('pt-PT')}
            </div>
          `)
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px');
      })
      .on('mouseout', function() {
        d3.select(this).style('opacity', 0.85);
        d3.select('#tooltip').style('opacity', 0);
      });
    
    // T√≠tulo do eixo Y
    g.append('text')
      .attr('transform', 'rotate(-90)')
      .attr('y', 0 - margin.left)
      .attr('x', 0 - (chartHeight / 2))
      .attr('dy', '1em')
      .style('text-anchor', 'middle')
      .style('font-size', '14px')
      .style('font-weight', 'bold')
      .text('N√∫mero de Habita√ß√µes');
  }
}

// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================

async function init() {
  try {
    const response = await fetch('habitacoes_por_ano.json');
    dadosOriginais = await response.json();
    
    // Criar inst√¢ncias
    instances['1a'] = new TreemapInstance('1a', 'treemap1a');
    instances['1b'] = new TreemapInstance('1b', 'treemap1b');
    instances['1c'] = new BarChartInstance('1c');
    instances['2'] = new TreemapInstance('2', 'treemap2');
    
    // Desenhar inicial
    instances['1a'].update();
    instances['1b'].update();
    instances['2'].update();
    
  } catch (error) {
    console.error('Erro ao carregar dados:', error);
    alert('N√£o foi poss√≠vel carregar os dados. Certifica-te que o ficheiro habitacoes_por_ano.json est√° na mesma pasta.');
  }
}

// ============================================================================
// MODO ESCURO
// ============================================================================

function toggleDark() {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('darkMode', isDark ? 'true' : 'false');
  
  // Recarregar p√°gina para aplicar mudan√ßa
  window.location.reload();
}

// Restaurar modo escuro e atualizar bot√£o
const isDarkMode = localStorage.getItem('darkMode') === 'true';
if (isDarkMode) {
  document.body.classList.add('dark');
}

// Atualizar √≠cone do bot√£o
function updateDarkModeButton() {
  const icon = document.getElementById('darkModeIcon');
  const btn = document.getElementById('darkModeBtn');
  if (icon && btn) {
    if (isDarkMode) {
      icon.textContent = '‚òÄÔ∏è';
      btn.setAttribute('title', 'Mudar para modo claro');
    } else {
      icon.textContent = 'üåô';
      btn.setAttribute('title', 'Mudar para modo escuro');
    }
  }
}

// Atualizar ao carregar
updateDarkModeButton();

// Iniciar quando p√°gina carregar
document.addEventListener('DOMContentLoaded', init);
</script>

<footer style="text-align: center; padding: 20px; font-size: 12px; opacity: 0.7;">
  ¬© VIS ¬∑ Trabalho de Grupo ‚Äî 2025 ¬∑ Universidade Aberta & UTAD
</footer>

</body>
</html>
