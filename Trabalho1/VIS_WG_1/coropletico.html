<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Mapa Coropl√©tico ‚Äî Habita√ß√µes por Distrito (1940‚Äì2021)</title>

  <!-- Carregar modo escuro IMEDIATAMENTE -->
  <script>
    if (localStorage.getItem('darkMode') === 'true') {
      document.write('<style>body{background:#1a1a1a!important;color:#e0e0e0!important;}</style>');
    }
  </script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #f5f7fa;
      --card-bg: white;
      --text: #2c3e50;
      --border: #e1e8ed;
      --primary: #005b96;
      --header-bg: linear-gradient(135deg, #005b96, #5a2a82);
    }

    body.dark {
      --bg: #1a1a1a;
      --card-bg: #2d2d2d;
      --text: #e0e0e0;
      --border: #444;
      --primary: #64b5f6;
      --header-bg: linear-gradient(135deg, #000000, #3a1757);
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
    }

    header {
      background: var(--header-bg);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    header p {
      margin: 5px 0 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .back-btn {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 5px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .dark-toggle {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s;
    }

    .dark-toggle:hover {
      background: rgba(255,255,255,0.3);
    }

    #map {
      width: 100%;
      height: calc(100vh - 140px);
    }

    .controls {
      background: var(--card-bg);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
    }

    .controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .controls select {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--card-bg);
      color: var(--text);
    }

    .info {
      padding: 8px 12px;
      background: var(--card-bg);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 12px;
      color: var(--text);
    }

    .info h4 {
      margin: 0 0 5px;
      font-size: 14px;
      color: var(--text);
    }

    .legend {
      line-height: 18px;
      color: var(--text);
      padding: 6px 8px;
      background: var(--card-bg);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 12px;
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 6px;
      opacity: 0.8;
    }

    .source-box {
      background: var(--card-bg);
      padding: 15px 20px;
      font-size: 11px;
      color: var(--text);
      border-top: 1px solid var(--border);
      text-align: center;
    }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="back-btn">‚Üê Voltar ao in√≠cio</a>
  
  <h1>
    üó∫Ô∏è Mapa Coropl√©tico
  </h1>
  <p>Habita√ß√µes por Distrito ‚Äî Portugal (1940‚Äì2021)</p>
  
  <button class="dark-toggle" onclick="toggleDark()" id="darkModeBtn" title="Alternar modo">
    <span id="darkModeIcon">üåô</span>
  </button>
</header>

<div class="controls">
  <label>
    üìÖ Ano:
    <select id="year-select">
      <option value="1940">1940</option>
      <option value="1950">1950</option>
      <option value="1960">1960</option>
      <option value="1981">1981</option>
      <option value="1991">1991</option>
      <option value="2001">2001</option>
      <option value="2011">2011</option>
      <option value="2021" selected>2021</option>
    </select>
  </label>
  
  <label>
    üé® Paleta de Cores:
    <select id="color-select">
      <option value="Blues" >Blues (Azul)</option>
      <option value="Greens">Greens (Verde)</option>
      <option value="Reds">Reds (Vermelho)</option>
      <option value="Purples">Purples (Roxo)</option>
      <option value="Oranges" selected>Oranges (Laranja)</option>
      <option value="Gray">Escala de Cinzentos</option>
    </select>
  </label>
</div>

<div id="map"></div>

<div class="source-box">
  <strong>Fonte:</strong> INE ‚Äî Alojamentos familiares cl√°ssicos √† data dos Censos (dados normalizados pelo autor).<br>
  <strong>Limites distritais:</strong> OpenDataSoft ‚Äî georef-portugal-distrito-millesime.
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<script>
  let hab = null;
  let currentYear = "2021";
  let currentPalette = "Oranges";
  let geojsonLayer = null;
  let map, info, legend;

  // Aplicar modo escuro ao carregar
  const isDarkMode = localStorage.getItem('darkMode') === 'true';
  if (isDarkMode) {
    document.body.classList.add('dark');
  }

  // Atualizar √≠cone do bot√£o
  function updateDarkModeButton() {
    const icon = document.getElementById('darkModeIcon');
    const btn = document.getElementById('darkModeBtn');
    if (icon && btn) {
      if (isDarkMode) {
        icon.textContent = '‚òÄÔ∏è';
        btn.setAttribute('title', 'Mudar para modo claro');
      } else {
        icon.textContent = 'üåô';
        btn.setAttribute('title', 'Mudar para modo escuro');
      }
    }
  }
  updateDarkModeButton();

  function toggleDark() {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    window.location.reload();
  }

  function getColor(d) {
    const palettes = {
      "Blues": ['#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#084594'],
      "Greens": ['#e5f5e0', '#c7e9c0', '#a1d99b', '#74c476', '#41ab5d', '#238b45', '#005a32'],
      "Reds": ['#fee5d9', '#fcbba1', '#fc9272', '#fb6a4a', '#ef3b2c', '#cb181d', '#99000d'],
      "Purples": ['#efedf5', '#dadaeb', '#bcbddc', '#9e9ac8', '#807dba', '#6a51a3', '#4a1486'],
      "Oranges": ['#feedde', '#fdd0a2', '#fdae6b', '#fd8d3c', '#f16913', '#d94801', '#8c2d04'],
      "Gray": ['#f7f7f7', '#d9d9d9', '#bdbdbd', '#969696', '#737373', '#525252', '#252525']
    };

    const c = palettes[currentPalette] || palettes["Blues"];

    return d > 350000 ? c[6] :
           d > 250000 ? c[5] :
           d > 180000 ? c[4] :
           d > 120000 ? c[3] :
           d > 90000  ? c[2] :
           d > 70000  ? c[1] : c[0];
  }

  function style(feature) {
    if (!hab) {
      return {
        fillColor: '#cccccc',
        weight: 1,
        opacity: 1,
        color: '#ffffff',
        fillOpacity: 0.7
      };
    }

    const dist = feature.properties.dis_name;
    const value = hab[currentYear] && hab[currentYear][dist] ? hab[currentYear][dist] : 0;

    return {
      fillColor: getColor(value),
      weight: 1,
      opacity: 1,
      color: '#ffffff',
      fillOpacity: 0.9
    };
  }

  function initMap() {
    map = L.map('map', {
      zoomSnap: 0.25
    });

    map.setView([39.5, -8.0], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    info = L.control();
    info.onAdd = function () {
      this._div = L.DomUtil.create('div', 'info');
      this.update();
      return this._div;
    };
    info.update = function (props) {
      if (!props || !hab) {
        this._div.innerHTML = '<h4>Habita√ß√µes por distrito</h4>Passe o rato sobre um distrito.';
        return;
      }
      const dist = props.dis_name;
      const val = hab[currentYear][dist];
      this._div.innerHTML =
        '<h4>Habita√ß√µes (' + currentYear + ')</h4>' +
        '<b>' + dist + '</b><br/>' +
        (val ? val.toLocaleString('pt-PT') + ' habita√ß√µes' : 'Sem dados');
    };
    info.addTo(map);

    legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      const grades = [70000, 90000, 120000, 180000, 250000, 350000];

      div.innerHTML += '<strong>Habita√ß√µes (' + currentYear + ')</strong><br>';

      for (let i = 0; i < grades.length; i++) {
        const from = grades[i];
        const to = grades[i + 1];

        div.innerHTML +=
          '<i style="background:' + getColor(from + 1) + '"></i> ' +
          from.toLocaleString('pt-PT') +
          (to ? ' ‚Äì ' + to.toLocaleString('pt-PT') + '<br>' : '+');
      }

      return div;
    };
    legend.addTo(map);

    fetch('georef-portugal-distrito-millesime.geojson')
      .then(r => r.json())
      .then(data => {
        geojsonLayer = L.geoJSON(data, {
          style: style,
          onEachFeature: onEachFeature
        }).addTo(map);

        map.fitBounds(geojsonLayer.getBounds());
      })
      .catch(err => {
        console.error('Erro a carregar GeoJSON:', err);
        alert('N√£o foi poss√≠vel carregar georef-portugal-distrito-millesime.geojson');
      });
  }

  function highlightFeature(e) {
    const layer = e.target;

    layer.setStyle({
      weight: 2,
      color: '#000',
      fillOpacity: 1
    });

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
      layer.bringToFront();
    }

    info.update(layer.feature.properties);
  }

  function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);
    info.update();
  }

  function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
  }

  function onEachFeature(feature, layer) {
    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight,
      click: zoomToFeature
    });
  }

  function onYearChange(year) {
    currentYear = year;

    if (geojsonLayer) {
      geojsonLayer.setStyle(style);
    }

    legend.remove();
    legend.addTo(map);
    info.update();
  }

  function onColorChange(palette) {
    currentPalette = palette;

    if (geojsonLayer) {
      geojsonLayer.setStyle(style);
    }

    legend.remove();
    legend.addTo(map);
    info.update();
  }

  fetch('habitacoes_por_ano.json')
    .then(r => r.json())
    .then(data => {
      hab = data;
      initMap();
    })
    .catch(err => {
      console.error('Erro a carregar habitacoes_por_ano.json:', err);
      alert('N√£o foi poss√≠vel carregar habitacoes_por_ano.json');
    });

  document.addEventListener('DOMContentLoaded', () => {
    const yearSelect = document.getElementById('year-select');
    const colorSelect = document.getElementById('color-select');

    yearSelect.addEventListener('change', function () {
      onYearChange(this.value);
    });

    colorSelect.addEventListener('change', function () {
      onColorChange(this.value);
    });
  });
</script>

<footer style="text-align: center; padding: 20px; font-size: 12px; opacity: 0.7;">
  ¬© VIS ¬∑ Trabalho de Grupo ‚Äî 2025 ¬∑ Universidade Aberta & UTAD
</footer>

</body>
</html>
